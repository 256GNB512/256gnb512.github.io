<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centered Div with Absolute Child</title>

    <script src="divsLib.js"></script>
    <script src="varietyLib.js"></script>

    <script>


const animation_speed = 0.03;
//const scheduled_actions = [];

let animations_current = [0, 0, 0, 0];
let animations_targets = [0, 0, 0, 0];
let carousel;
let scroll_snap_controller = 0;
let valid_images = [];
let is_carousel_at_top = false;
let carousel_frame_a;
let carousel_frame_b;
let is_at_frame_b = false;
let is_animating_carousel = false;
let current_frame_image_index = 0;




function makeClickable(element, inputFunction) 
{
    if (element instanceof HTMLElement) {
        element.addEventListener("click", () => {
            inputFunction();
            //console.log("Element " + element.id + " clicked!");
        });
    } else {
        console.error("Provided argument is not a valid DOM element.");
    }
}




function startUpdateLoop(updateFunction) 
{
    let isRunning = true; // Control variable to start/stop the loop

    // Define the loop function
    function loop(timestamp) {
        if (!isRunning) return; // Stop the loop if isRunning is false

        // Call the update function
        updateFunction(timestamp);

        // Request the next frame
        requestAnimationFrame(loop);
    }

    // Start the loop
    requestAnimationFrame(loop);

    // Return a function to stop the loop
    return () => {
        isRunning = false;
    };
}




function addArrowSkipperGraphic(parentDiv, imagePath, horFlip = true) 
{
    // Ensure the parent div is positioned and has overflow hidden
    parentDiv.style.position = 'relative';
    parentDiv.style.overflow = 'hidden';

    // Create a pseudo-element for the flipped image
    const pseudoElement = document.createElement('div');
    pseudoElement.style.content = '""';
    pseudoElement.style.position = 'absolute';
    pseudoElement.style.top = '0';
    pseudoElement.style.left = '0';
    pseudoElement.style.width = '100%';
    pseudoElement.style.height = '100%';
    pseudoElement.style.backgroundImage = `url('${imagePath}')`; // Set the image from the input path
    pseudoElement.style.backgroundSize = 'cover'; // Ensure the image covers the pseudo-element
    if (horFlip) {
        pseudoElement.style.transform = 'scaleX(-1)'; // Flip the image horizontally
    }
    pseudoElement.style.zIndex = '-1'; // Place it behind the content

    // Append the pseudo-element to the parent div
    parentDiv.appendChild(pseudoElement);
    return pseudoElement;
}

function setupScrollListeners(
    onWheel = () => { },
    onArrowKey = () => { },
    onTouchMove = () => { },
    onTouchStart = () => { },
    onTouchEnd = () => { }
) 
{
    document.addEventListener('wheel', (event) => {
        onWheel(event.deltaX, event.deltaY);
    });

    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', (event) => {
        touchStartX = event.touches[0].clientX;
        touchStartY = event.touches[0].clientY;
        onTouchStart(touchStartX, touchStartY);
    });

    document.addEventListener('touchmove', (event) => {
        let touchEndX = event.touches[0].clientX;
        let touchEndY = event.touches[0].clientY;
        let deltaX = touchStartX - touchEndX;
        let deltaY = touchStartY - touchEndY;
        onTouchMove(deltaX, deltaY);
    });

    document.addEventListener('touchend', (event) => {
        let touchEndX = event.touches[0].clientX;
        let touchEndY = event.touches[0].clientY;
        let deltaX = touchStartX - touchEndX;
        let deltaY = touchStartY - touchEndY;
        onTouchEnd(deltaX, deltaY);
    });


    document.addEventListener('keyup', (event) => {
        if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(event.key)) {
            onArrowKey(event.key);
        }
    });
}

function addCarouselArrows(parentDiv, rect1Width) 
{
    // Ensure the parent div has a defined height
    if (!parentDiv.style.height) {
        parentDiv.style.height = '100%'; // Default to full height if not set
    }

    // Create the first rectangle
    const rect1 = document.createElement('div');
    rect1.style.width = `${rect1Width}px`; // Set width
    rect1.style.height = '100%'; // Inherit height from parent
    //rect1.style.backgroundColor = 'red'; // Just for visibility
    rect1.style.display = 'inline-block'; // Display rectangles side by side
    rect1.style.position = 'absolute';
    rect1.style.left = '0';
    rect1.style.top = '50%';
    rect1.style.transform = 'translateY(-50%)';
    rect1.style.transformOrigin = '0 50%'; // Anchor point at (0, 0.5)
    designateTagToDom(rect1, "carouselBtnL");

    const newSquare1 = addCenteredSquare(rect1, rect1Width, true);
    const leftArrow = addArrowSkipperGraphic(newSquare1, "arrow.png");
    designateIdToDom(rect1, 'carouselLftClickArea');
    designateIdToDom(leftArrow, 'carouselLftArrow');

    // Create the second rectangle
    const rect2 = document.createElement('div');
    rect2.style.width = `${rect1Width}px`; // Set width
    rect2.style.height = '100%'; // Inherit height from parent
    //rect2.style.backgroundColor = 'blue'; // Just for visibility
    rect2.style.display = 'inline-block'; // Display rectangles side by side
    rect2.style.position = 'absolute';
    rect2.style.right = '0';
    rect2.style.top = '50%';
    rect2.style.transform = 'translateY(-50%)';
    rect2.style.transformOrigin = '100% 50%'; // Anchor point at (1, 0.5)
    designateTagToDom(rect2, "carouselBtnR");
    const newSquare2 = addCenteredSquare(rect2, rect1Width, false);
    const rightArrow = addArrowSkipperGraphic(newSquare2, "arrow.png", false);
    designateIdToDom(rect2, 'carouselRgtClickArea');
    designateIdToDom(rightArrow, 'carouselRgtArrow');




    makeClickable(rect1, previousCarouselImage);
    makeClickable(rect2, nextCarouselImage);

    // Append the rectangles to the parent div
    parentDiv.appendChild(rect1);
    parentDiv.appendChild(rect2);
}
// Function to create a centered container
function createMainWindow(height, width) 
{
    // Create the container
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.justifyContent = 'center';
    container.style.alignItems = 'center';
    container.style.height = height;
    container.style.width = width;
    container.style.backgroundColor = getRandomColor(); // Random color
    container.style.fontFamily = 'Arial, sans-serif';
    container.style.boxSizing = 'border-box'; // Ensure padding/borders don't affect dimensions
    container.style.position = 'relative'; // Make the container a positioning context

    designateIdToDom(container, 'mainWindow');


    // Return the container (without text)
    return container;
}


// Function to add a 100x100 pixel child element to a parent DOM object

function interpolateAnimations()
{
    for (let i = 0; i < 4; i++) 
    {
        if (animations_current[i] != animations_targets[i]) 
        {
            animations_current[i] = lerp(animations_current[i], animations_targets[i], animation_speed);
            animations_current[i] = snapToTarget(animations_current[i], animations_targets[i], animation_speed);
        }
    }
}

function carouselTopSnappingAnimation()
{
    if(!is_carousel_at_top && animations_targets[0] != 0)
    {
        animations_targets[0] = lerp(animations_targets[0], 0, animation_speed);
        animations_targets[0] = snapToTarget(animations_targets[0], 0, animation_speed);
    } 
    else if(is_carousel_at_top && animations_targets[0] != 100)
    {
        animations_targets[0] = lerp(animations_targets[0], 100, animation_speed);
        animations_targets[0] = snapToTarget(animations_targets[0], 100, animation_speed);
    }
    scroll_snap_controller = animations_targets[0];
    carousel.style.transform = 'translate(' + -50 + '%, ' + -(50 + animations_current[0]) + '%)';
}


function setCurrentHorizontalPositionsForFrameA()
{
    carousel_frame_a.style.transform = 'translate(' + (-50 + animations_current[1]) + '%, ' + (-50) + '%)';
}
function setCurrentHorizontalPositionsForFrameB()
{
    carousel_frame_b.style.transform = 'translate(' + (-50 + animations_current[2]) + '%, ' + (-50) + '%)';
}

function carouselSnapshotTransitionAnim ()
{
    //carousel_frame_a.style.transform = 'translate(' + -40 + '%, ' + (-50) + '%)';
    if(animations_current[1] != animations_targets[1])
    {
        setCurrentHorizontalPositionsForFrameA();
        //carousel_frame_a.style.transform = 'translate(' + (-50 + animations_current[1]) + '%, ' + (-50) + '%)';
    }
    if(animations_current[2] != animations_targets[2])
    {
        setCurrentHorizontalPositionsForFrameB();
        //carousel_frame_a.style.transform = 'translate(' + (-50 + animations_current[2]) + '%, ' + (-50) + '%)';
    }
}

function getSafeIndex(index, length) {
    if (length <= 0) return [];

    // Normalize index within bounds
    index = ((index % length) + length) % length;
    
    // Compute left and right indexes
    //let left = ((index - 1) % length + length) % length;
    //let right = ((index + 1) % length + length) % length;

    return index;
}


function continuousUpdate() 
{    
    /*while(scheduled_actions.length > 0)
    {
        scheduled_actions[0]();
        scheduled_actions.shift();
    }*/
    //console.log(animations_current[1]);
    interpolateAnimations();

    if (carousel != undefined) 
    {
        carouselTopSnappingAnimation();
    }
    if(carousel_frame_a != undefined && carousel_frame_b != undefined)
    {
        carouselSnapshotTransitionAnim();
    }
    // Call the function again on the next frame
    requestAnimationFrame(continuousUpdate);
}

function teleportAToLeft()
{
    animations_current[1] = -100;
    animations_targets[1] = -100;
    setCurrentHorizontalPositionsForFrameA();
}
function teleportAToRight()
{
    animations_targets[1] = 100;
    animations_current[1] = 100;
    setCurrentHorizontalPositionsForFrameA();
}
function teleportBToLeft()
{
    animations_targets[2] = -100;
    animations_current[2] = -100;
    setCurrentHorizontalPositionsForFrameB();
}
function teleportBToRight()
{
    animations_targets[2] = 100;
    animations_current[2] = 100;
    setCurrentHorizontalPositionsForFrameB();
}
function teleportAToCenter()
{
    animations_targets[1] = 0;
    animations_current[1] = 0;
    setCurrentHorizontalPositionsForFrameA();
}
function teleportBToCenter()
{
    animations_targets[2] = 0;
    animations_current[2] = 0;
    setCurrentHorizontalPositionsForFrameB();
}
function moveAToLeft()
{
    animations_targets[1] = -100;
}
function moveAToRight()
{
    animations_targets[1] = 100;
}
function moveAToCenter()
{
    animations_targets[1] = 0;
}
function moveBToLeft()
{
    animations_targets[2] = -100;
}
function moveBToRight()
{
    animations_targets[2] = 100;
}
function moveBToCenter()
{
    animations_targets[2] = -0;
}




nextCarouselImage = function()
{
    if(!is_at_frame_b)
    {
        //is_animating_carousel = true;
        //moveAToLeft();
        teleportBToLeft();
        moveBToCenter();
        moveAToRight();
        current_frame_image_index++;
        is_at_frame_b = true;
        current_frame_image_index = getSafeIndex(current_frame_image_index, valid_images.length);
        setImageAsTexture(carousel_frame_b, valid_images[current_frame_image_index]);
        //scheduled_actions.push(moveBToRight);
    }
    else if(is_at_frame_b)
    {
        //is_animating_carousel = true;
        //moveAToLeft();
        teleportAToLeft();
        moveAToCenter();
        moveBToRight();
        current_frame_image_index++;
        is_at_frame_b = false;
        current_frame_image_index = getSafeIndex(current_frame_image_index, valid_images.length);
        setImageAsTexture(carousel_frame_a, valid_images[current_frame_image_index]);
        //scheduled_actions.push(moveBToRight);
    }
}

previousCarouselImage = function()
{
    if(!is_at_frame_b)
    {
        //is_animating_carousel = true;
        //moveAToLeft();
        teleportBToRight();
        moveBToCenter();
        moveAToLeft();
        current_frame_image_index--;
        is_at_frame_b = true;
        current_frame_image_index = getSafeIndex(current_frame_image_index, valid_images.length);
        setImageAsTexture(carousel_frame_b, valid_images[current_frame_image_index]);
        //scheduled_actions.push(moveBToRight);
    }
    else if(is_at_frame_b)
    {
        //is_animating_carousel = true;
        //moveAToLeft();
        teleportAToRight();
        moveAToCenter();
        moveBToLeft();
        current_frame_image_index--;
        is_at_frame_b = false;
        current_frame_image_index = getSafeIndex(current_frame_image_index, valid_images.length);
        setImageAsTexture(carousel_frame_a, valid_images[current_frame_image_index]);
        //scheduled_actions.push(moveBToRight);
    }
}


snapCarouselToTop = function () 
{
    animations_targets[0] = 100;
    scroll_snap_controller = 0;
    is_carousel_at_top = true;
}
snapCarouselToBottom = function () 
{
    animations_targets[0] = 0;
    scroll_snap_controller = 0;
    is_carousel_at_top = false;
}
tryScrollSnapping = function (dist) 
{
    scroll_snap_controller += dist * 0.05;
    animations_targets[0] = scroll_snap_controller ;
    let tenPercentHeight = window.innerHeight * 0.02;
    if(!is_carousel_at_top && scroll_snap_controller > tenPercentHeight){
        snapCarouselToTop();
    }
    else if(is_carousel_at_top && scroll_snap_controller  < 100 - tenPercentHeight){
        snapCarouselToBottom();
    }
}

arrowKeyPressed = function (key) 
{
    if (key == 'ArrowUp' && !is_carousel_at_top) {
        snapCarouselToTop();
    }
    if (key == 'ArrowDown' && is_carousel_at_top) {
        snapCarouselToBottom();
    }
    if (key == 'ArrowLeft' && !is_carousel_at_top) {
        previousCarouselImage();
    }
    if (key == 'ArrowRight' && !is_carousel_at_top) {
        nextCarouselImage();
    }
}

let horizontal_touch_controller = 0;

scrolling = function (dx, dy) 
{
    if (dy < 1) {
        tryScrollSnapping(dy);
    }
    else if (dy > 1) {
        tryScrollSnapping(dy);
    }
}

touchStart = function(dx, dy)
{
    horizontal_touch_controller = 0;
}

touchEnd = function(dx, dy)
{
    
}

function tryHorizontalDragging()
{
    if(is_at_frame_b)
    {
        animations_targets[2] = horizontal_touch_controller; 
    }
}


touching = function (dx, dy) 
{
    if (dy < 5) {
        tryScrollSnapping(dy);
    }
    else if (dy > 5) {
        tryScrollSnapping(dy);
    }
    if(Math.abs(dx) >= 1 && !is_carousel_at_top)
    {
        horizontal_touch_controller += dx;
        tryHorizontalDragging();
    }
}

// Start the loop
continuousUpdate();
// Function to initialize the page
function mainFunction() 
{
    // Reset default styles for body and html
    document.body.style.margin = '0';
    document.body.style.padding = '0';
    document.body.style.overflow = 'hidden'; // Prevent scrollbars
    document.documentElement.style.height = '100%'; // Ensure html takes full height

    // Create the centered container
    const main_window = createMainWindow('100vh', '100vw');

    // Add the container to the body
    document.body.appendChild(main_window);



    // Add a 100x100 pixel child element to the centered container
    carousel = addChildElement(
        main_window,
        '100%', '100%',
        '50%', '50%',
        'translate(-50%, -50%)'
    );


    carousel_frame_a = addChildElement(
        carousel,
        '100%', '100%',
        '50%', '50%',
        'translate(-50%, -50%)'
    );

    carousel_frame_b = addChildElement(
        carousel,
        '100%', '100%',
        '50%', '50%',
        'translate(-50%, -50%)'
    );
/*
    const carousel_frame_c = addChildElement(
        carousel,
        '100%', '100%',
        '50%', '50%',
        'translate(-50%, -50%)'
    );
    
    const carousel_frame_d = addChildElement(
        carousel,
        '20%', '100%',
        '80%', '50%',
        'translate(-50%, -50%)'
    );*/
    const imgPaths = generateImagePaths(100);


    loadAllImages(imgPaths, loadedImages => {
        valid_images = sortAlphabeticallyCaseInsensitive(valid_images);
        setImageAsTexture(carousel_frame_b, valid_images[valid_images.length - 1]);
        setImageAsTexture(carousel_frame_a, valid_images[0]);
        //setImageAsTexture(carousel_frame_c, valid_images[1]);

        //continuousUpdate();
    });


    

    setupScrollListeners(
        (dx, dy) => scrolling(dx, dy * -1),
        (key) => arrowKeyPressed(key),
        (dx, dy) => touching(dx, dy),
        (dx, dy) => touchStart(dx, dy),
        (dx, dy) => touchEnd(dx, dy)
    );


    teleportBToRight();
    //scheduled_actions.push(teleportAToLeft);
    //scheduled_actions.push(teleportBToRight);
    addCarouselArrows(carousel, 50); // Replace 50 with your desired width
}

window.onload = mainFunction;

    </script>
</head>

<body>
    <!-- Everything will be created by JavaScript -->
</body>

</html>